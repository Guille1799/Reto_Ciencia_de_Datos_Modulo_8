---
title: "Dashboard de la Felicidad Mundial (World Happiness Report)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: spacelab
runtime: shiny
---


```{r setup, include=FALSE}

library(flexdashboard)
library(shiny)
library(readxl)
library(dplyr)
library(tidyr)
library(plotly)
library(highcharter)
library(countrycode)
library(viridis)
```

```{r data_loading, include=FALSE}
# --- MI PROCESO DE CARGA Y LIMPIEZA DE DATOS ---

# 1. Primero, defino dónde están mis archivos para que R sepa dónde buscarlos.
# Ambos datasets (felicidad y población) están en el mismo archivo Excel.
file_path <- '_WHR-Happiness - Dataset - v5.xlsx'
sheet_name_happiness <- 'input-data2008-2023_Happiness_I' # Nombre de la hoja de felicidad
sheet_name_population <- 'datapop#v8@fasttrackyearcountri' 

# 2. He creado una función para limpiar mis datos de felicidad.
load_and_clean_data <- function(file_path, sheet_name) {
  df <- read_excel(file_path, sheet = sheet_name)
  
  df <- df %>%
    select(
      `Country name`, year, `Life Ladder`, `Log GDP per capita`, `Social support`,
      `Healthy life expectancy at birth`, `Freedom to make life choices`,
      `Perceptions of corruption`, Generosity
    ) %>%
    rename(
      Country = `Country name`, Year = year, Happiness = `Life Ladder`,
      GDP = `Log GDP per capita`, SocialSupport = `Social support`,
      HealthyLifeExpectancy = `Healthy life expectancy at birth`,
      Freedom = `Freedom to make life choices`, Corruption = `Perceptions of corruption`
    ) %>%
    drop_na(Happiness, GDP, SocialSupport, HealthyLifeExpectancy, Freedom, Corruption)
  
  return(df)
}

# 3. También he creado una función específica para cargar los datos de población
load_population_data <- function(file_path, sheet_name) {
    df_pop <- read_excel(file_path, sheet = sheet_name) 

    df_pop <- df_pop %>%
        select(name, time, Population) %>%
        rename(Country = name, Year = time) %>%
        drop_na(Population) 
  
    return(df_pop)
}

# 4. Ejecuto las funciones que he creado y uno los resultados.
# Paso los nombres de las hojas correctas a cada función.
df_clean <- load_and_clean_data(file_path, sheet_name_happiness)
df_pop <- load_population_data(file_path, sheet_name_population) 

# Con left_join, uno mis dos tablas. Busco las filas que coincidan en País y Año
# para tener toda la información en un único sitio: mi tabla 'df_final'.
df_final <- left_join(df_clean, df_pop, by = c("Country", "Year")) %>%
            # Me aseguro de quitar filas si no tienen dato de población.
            drop_na(Population) 

# 5. Para el mapa del mundo, necesito códigos de país estandarizados (por ejemplo, 'ESP' para España).
# Uso la función countrycode para que me los genere automáticamente.
df_final$iso_a3 <- countrycode(df_final$Country, "country.name", "iso3c")

# 6. Finalmente, creo una lista con todos los nombres de los países.

country_list <- unique(df_final$Country)

```

Sidebar {.sidebar}
-----------------------------------------------------------------------

### Controles Interactivos


```{r}
# --- SLIDER PARA EL AÑO ---
sliderInput("selectedYear", 
            "Selecciona un año:",
            min = min(df_final$Year), 
            max = max(df_final$Year),
            value = 2022, # Año 2022 por defecto
            step = 1,
            sep = "",
            animate = animationOptions(interval = 1500, loop = FALSE))

# --- SELECTOR DE PAÍSES ---
selectInput("selectedCountries", 
            "Selecciona países para comparar tendencias:",
            choices = country_list,
            selected = c("Spain", "Germany", "France", "Finland"),
            multiple = TRUE)

# --- TEXTO EXPLICATIVO ---
helpText("El gráfico de burbujas, el mapa y los rankings se actualizan con el slider de año. El gráfico de líneas se actualiza con la selección de países.")
```

Column {data-width=650}
-----------------------------------------------------------------------
###
#### Felicidad vs. Riqueza a lo largo del Tiempo


```{r}
# --- GRÁFICO DE BURBUJAS ---
renderPlotly({
  df_filtered_year <- df_final %>% filter(Year == input$selectedYear)
  plot_ly(
    df_filtered_year, x = ~GDP, y = ~Happiness, size = ~Population, color = ~Country, 
    text = ~paste("País:", Country, "<br>Felicidad:", round(Happiness, 2)),
    hoverinfo = "text", type = 'scatter', mode = 'markers'
  ) %>%
  layout(
    title = paste("Felicidad, Riqueza y Población en", input$selectedYear),
    xaxis = list(title = "PIB per cápita (Log)"),
    yaxis = list(title = "Puntuación de Felicidad"),
    showlegend = FALSE
  )
})
```

### {data-height=450}

#### Evolución de la Felicidad por País

```{r}
# --- GRÁFICO DE LÍNEAS ---
renderPlotly({
  df_filtered_countries <- df_final %>% filter(Country %in% input$selectedCountries)
  plot_ly(
    df_filtered_countries, x = ~Year, y = ~Happiness, color = ~Country,
    type = 'scatter', mode = 'lines+markers'
  ) %>%
  layout(
    title = "Evolución de la Felicidad",
    xaxis = list(title = "Año"),
    yaxis = list(title = "Puntuación de Felicidad"),
    legend = list(orientation = 'h', xanchor = "center", x = 0.5)
  )
})
```

Column {data-width=350}
-----------------------------------------------------------------------

### {data-height=500}

#### Distribución Geográfica de la Felicidad

```{r}
# --- MAPA COROPLÉTICO ---
renderHighchart({
  df_map <- df_final %>% filter(Year == input$selectedYear)
  hcmap(
    "custom/world-lowres", data = df_map, value = "Happiness",
    joinBy = c("iso-a3", "iso_a3"), name = "Puntuación de Felicidad",
    dataLabels = list(enabled = FALSE), borderColor = "#FAFAFA", borderWidth = 0.1,
    tooltip = list(valueDecimals = 2, valueSuffix = " puntos")
  ) %>%
  hc_colorAxis(min = min(df_final$Happiness), max = max(df_final$Happiness), stops = color_stops(colors = viridis(10))) %>%
  hc_title(text = paste("Mapa de Felicidad en", input$selectedYear))
})
```
### {data-height=500}

#### Ranking de Países

```{r}
# --- GRÁFICO DE BARRAS DE RANKING ---
renderPlotly({
  df_rank <- df_final %>% filter(Year == input$selectedYear) %>% arrange(desc(Happiness))
  top_10 <- head(df_rank, 10)
  bottom_10 <- tail(df_rank, 10)
  
  p_top <- plot_ly(
    top_10, x = ~Happiness, y = ~reorder(Country, Happiness),
    type = 'bar', orientation = 'h',
    hoverinfo = 'text', text = ~paste(round(Happiness, 2))
  ) %>% layout(
      yaxis = list(title = ""), xaxis = list(title = "Felicidad", range = c(2, 8)), 
      margin = list(l=100), hoverlabel = list(font = list(size = 16))
  )
  
  p_bottom <- plot_ly(
    bottom_10, x = ~Happiness, y = ~reorder(Country, Happiness),
    type = 'bar', orientation = 'h',
    hoverinfo = 'text', text = ~paste(round(Happiness, 2))
  ) %>% layout(
      yaxis = list(title = ""), xaxis = list(title = "Felicidad", range = c(2, 8)), 
      margin = list(l=100), hoverlabel = list(font = list(size = 16))
  )

  subplot(p_top, p_bottom, nrows = 2, shareX = TRUE, titleY = FALSE) %>%
    layout(title = paste("Rankings en", input$selectedYear), showlegend = FALSE)
})
```


