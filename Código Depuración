```{r data_loading, include=FALSE}
# --- MI PROCESO DE CARGA Y LIMPIEZA DE DATOS ---

# 1. Primero, defino dÃ³nde estÃ¡n mis archivos para que R sepa dÃ³nde buscarlos.
# Ambos datasets (felicidad y poblaciÃ³n) estÃ¡n en el mismo archivo Excel.
file_path <- '_WHR-Happiness - Dataset - v5.xlsx'
sheet_name_happiness <- 'input-data2008-2023_Happiness_I' # Nombre de la hoja de felicidad
sheet_name_population <- 'datapop#v8@fasttrackyearcountri' 

# 2. He creado una funciÃ³n para limpiar mis datos de felicidad.
load_and_clean_data <- function(file_path, sheet_name) {
  df <- read_excel(file_path, sheet = sheet_name)
  
  df <- df %>%
    select(
      `Country name`, year, `Life Ladder`, `Log GDP per capita`, `Social support`,
      `Healthy life expectancy at birth`, `Freedom to make life choices`,
      `Perceptions of corruption`, Generosity
    ) %>%
    rename(
      Country = `Country name`, Year = year, Happiness = `Life Ladder`,
      GDP = `Log GDP per capita`, SocialSupport = `Social support`,
      HealthyLifeExpectancy = `Healthy life expectancy at birth`,
      Freedom = `Freedom to make life choices`, Corruption = `Perceptions of corruption`
    ) %>%
    drop_na(Happiness, GDP, SocialSupport, HealthyLifeExpectancy, Freedom, Corruption)
  
  return(df)
}

# 3. TambiÃ©n he creado una funciÃ³n especÃ­fica para cargar los datos de poblaciÃ³n
load_population_data <- function(file_path, sheet_name) {
    df_pop <- read_excel(file_path, sheet = sheet_name) 

    df_pop <- df_pop %>%
        select(name, time, Population) %>%
        rename(Country = name, Year = time) %>%
        drop_na(Population) 
  
    return(df_pop)
}

# 4. Ejecuto las funciones que he creado y uno los resultados.
# Paso los nombres de las hojas correctas a cada funciÃ³n.
df_clean <- load_and_clean_data(file_path, sheet_name_happiness)
df_pop <- load_population_data(file_path, sheet_name_population) 

# Con left_join, uno mis dos tablas. Busco las filas que coincidan en PaÃ­s y AÃ±o
# para tener toda la informaciÃ³n en un Ãºnico sitio: mi tabla 'df_final'.
df_final <- left_join(df_clean, df_pop, by = c("Country", "Year")) %>%
            # Me aseguro de quitar filas si no tienen dato de poblaciÃ³n.
            drop_na(Population) 

# 5. Para el mapa del mundo, necesito cÃ³digos de paÃ­s estandarizados (por ejemplo, 'ESP' para EspaÃ±a).
# Uso la funciÃ³n countrycode para que me los genere automÃ¡ticamente.
df_final$iso_a3 <- countrycode(df_final$Country, "country.name", "iso3c")

# 6. Finalmente, creo una lista con todos los nombres de los paÃ­ses.

country_list <- unique(df_final$Country)

# (Opcional, en el codigo final he usado el country_list) Guardar la base de datos limpia en un nuevo archivo
write.csv(df_final, "datos_felicidad_limpios.csv", row.names = FALSE)

```
